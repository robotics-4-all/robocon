from typing import Any
import rospy

from commlib.endpoints import endpoint_factory, EndpointType, TransportType
from ros_msg_transform import ros_msg_to_dict, dict_to_ros_msg
from safe_eval import safe_eval


class DotDict(dict):
    """A dictionary that allows dot notation access to its items."""
    def __getattr__(self, name):
        try:
            value = self[name]
            if isinstance(value, dict):
                return DotDict(value)
            return value
        except KeyError:
            raise AttributeError(name)


class B2RTopicBridge:

    def __init__(self, ros_topic: str, msg_type: Any, broker_type: Any, broker_uri, broker_conn_params, transform=None, condition=None, condition_type=None):
        self.ros_topic = ros_topic
        self.broker_uri = broker_uri
        self.msg_type = msg_type
        self.broker_type = broker_type
        self.broker_conn_params = broker_conn_params
        self.transform = transform
        self.condition = condition
        self.condition_type = condition_type
        self.queue_size = 10

        self._init_ros_endpoint()
        self._init_broker_endpoint()
        print(f'Started B2R Topic Bridge: {broker_type.name.lower()}://{broker_uri} -> ros://{self.ros_topic}')

    def _init_ros_endpoint(self):
        self.ros_pub = rospy.Publisher(
            self.ros_topic,
            self.msg_type,
            queue_size=self.queue_size
        )

    def _init_broker_endpoint(self):
        self.bsub = endpoint_factory(EndpointType.Subscriber,
            self.broker_type)(
            topic=self.broker_uri,
            on_message=self.on_msg,
            conn_params=self.broker_conn_params
        )
        self.bsub.run()

    def on_msg(self, data):
        # Check condition first
        if self.condition is not None:
            context = DotDict(data)
            try:
                condition_met = safe_eval(self.condition, {"msg": context, "data": context})
                # For 'when': only forward if condition is True
                # For 'unless': only forward if condition is False
                should_forward = condition_met if self.condition_type == 'when' else not condition_met
                if not should_forward:
                    rospy.logdebug(f"Message filtered out by '{self.condition_type}' condition")
                    return
            except Exception as e:
                rospy.logerr(f"Condition evaluation error: {e}")
                return  # Don't forward on error
        
        if self.transform:
            # Use eval with data as context
            context = DotDict(data)
            transformed_data = {}
            for target, expr in self.transform.items():
                try:
                    transformed_data[target] = safe_eval(expr, {"msg": context, "data": context})
                except Exception as e:
                    rospy.logerr(f"Transformation error: {e}")
            data = transformed_data
        _msg = dict_to_ros_msg(data, self.msg_type)
        rospy.loginfo(f'Publishing: {_msg}')
        self.ros_pub.publish(_msg)


class R2BTopicBridge:

    def __init__(self, ros_topic: str, msg_type: Any,
                 broker_type: Any, broker_uri,
                 broker_conn_params, transform=None, condition=None, condition_type=None):
        self.ros_topic = ros_topic
        self.broker_uri = broker_uri
        self.msg_type = msg_type
        self.broker_type = broker_type
        self.broker_conn_params = broker_conn_params
        self.transform = transform
        self.condition = condition
        self.condition_type = condition_type

        self._init_broker_endpoint()
        self._init_ros_endpoint()
        print(f'Started R2B Topic Bridge: ros://{self.ros_topic} -> {broker_type.name.lower()}://{broker_uri}')

    def _init_ros_endpoint(self):
        self.ros_sub = rospy.Subscriber(
            self.ros_topic,
            self.msg_type,
            self.on_msg
        )

    def _init_broker_endpoint(self):
        self.bpub = endpoint_factory(EndpointType.Publisher,
            self.broker_type)(
            topic=self.broker_uri,
            conn_params=self.broker_conn_params
        )
        self.bpub.run()

    def on_msg(self, msg):
        _data = ros_msg_to_dict(msg)
        
        # Check condition first
        if self.condition is not None:
            context = DotDict(_data)
            try:
                condition_met = safe_eval(self.condition, {"msg": context, "data": context})
                should_forward = condition_met if self.condition_type == 'when' else not condition_met
                if not should_forward:
                    rospy.logdebug(f"Message filtered out by '{self.condition_type}' condition")
                    return
            except Exception as e:
                rospy.logerr(f"Condition evaluation error: {e}")
                return
        
        if self.transform:
            context = DotDict(_data)
            transformed_data = {}
            for target, expr in self.transform.items():
                try:
                    transformed_data[target] = safe_eval(expr, {"msg": context, "data": context})
                except Exception as e:
                    rospy.logerr(f"Transformation error: {e}")
            _data = transformed_data
        rospy.loginfo(f'Publishing: {_data}')
        self.bpub.publish(_data)